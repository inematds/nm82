Excelente, Nei ðŸ‘Œ â€”
aqui vai um **resumo tÃ©cnico e lÃ³gico completo** do que jÃ¡ fizemos e **como as relaÃ§Ãµes do seu sistema Supabase estÃ£o estruturadas**.
Ele consolida toda a arquitetura que vocÃª construiu atÃ© aqui: desde a ingestÃ£o de e-mails atÃ© o relacionamento entre pessoas, pagamentos e convites.

---

# ðŸ§­ VISÃƒO GERAL DO SISTEMA

VocÃª criou uma **base de dados relacional no Supabase/PostgreSQL** para gerenciar toda a automaÃ§Ã£o da sua comunidade (INEMA/FTD).
Essa base recebe dados de e-mails, extrai anexos, registra pessoas, controla pagamentos e convites â€” tudo automatizado via **n8n + Supabase + Gmail**.

---

## ðŸ“¦ TABELAS PRINCIPAIS

### **1. `emails`**

> ðŸ“¥ Armazena e-mails recebidos (via API do Gmail ou ingestÃ£o automatizada)

| Campo                                                        | DescriÃ§Ã£o                           |
| ------------------------------------------------------------ | ----------------------------------- |
| `message_id`                                                 | ID Ãºnico do e-mail (chave primÃ¡ria) |
| `from`, `to`, `subject`, `snippet`, `body_text`, `body_html` | Dados do conteÃºdo                   |
| `date_received`                                              | Data de recebimento                 |
| `attachments_count`, `raw_headers`                           | Metadados                           |
| ðŸ”— **Relacionamento**: 1:N com `email_attachments`           |                                     |

---

### **2. `email_attachments`**

> ðŸ“Ž Armazena os anexos vinculados aos e-mails

| Campo                                                                                                            | DescriÃ§Ã£o                |
| ---------------------------------------------------------------------------------------------------------------- | ------------------------ |
| `id`                                                                                                             | UUID Ãºnico do anexo      |
| `message_id`                                                                                                     | FK â†’ `emails.message_id` |
| `filename`, `mime_type`, `size`, `storage_path`                                                                  | Dados do arquivo         |
| `created_at`                                                                                                     | Data de upload           |
| ðŸ”— **Relacionamento:** cada e-mail pode ter vÃ¡rios anexos. <br> Dele podem surgir **comprovantes de pagamento**. |                          |

---

### **3. `pessoas_fisicas`**

> ðŸ‘¤ Tabela central de contatos e afiliados (padrinhos e afiliados)

| Campo                                                                | DescriÃ§Ã£o                             |
| -------------------------------------------------------------------- | ------------------------------------- |
| `id`                                                                 | UUID (chave primÃ¡ria)                 |
| `email`                                                              | Ãšnico, usado como chave de integraÃ§Ã£o |
| `nome`, `cpf`, `cidade`, `sexo`, `escolaridade`                      | Dados pessoais                        |
| `data_primeiro_contato`, `data_cadastro`                             | HistÃ³rico de relacionamento           |
| `data_ultimo_pagamento`, `valor_ultimo_pagamento`, `tipo_assinatura` | Dados financeiros consolidados        |
| `convites_enviados`, `convites_usados`, `ativo`, `data_ultimo_envio` | Controle da comunidade e convites     |
| ðŸ”— **Relacionamento:** 1:N com `pagamentos`                          |                                       |

---

### **4. `pagamentos`**

> ðŸ’° Registra cada transaÃ§Ã£o financeira individual

| Campo                                                                                                   | DescriÃ§Ã£o                                 |
| ------------------------------------------------------------------------------------------------------- | ----------------------------------------- |
| `id`                                                                                                    | UUID (chave primÃ¡ria)                     |
| `pessoa_id`                                                                                             | FK â†’ `pessoas_fisicas.id`                 |
| `data_pagamento`, `valor`, `tipo_pagamento`, `tipo_assinatura`                                          | Dados financeiros                         |
| `origem_anexo_id`                                                                                       | FK â†’ `email_attachments.id` (comprovante) |
| `criado_em`                                                                                             | Timestamp de inserÃ§Ã£o                     |
| ðŸ”— **Relacionamentos:**<br> `pessoa_id` â†’ `pessoas_fisicas`<br> `origem_anexo_id` â†’ `email_attachments` |                                           |

---

## ðŸ”— RELAÃ‡Ã•ES ENTRE AS TABELAS

```
emails (1) â”€â”€â”€â”€< email_attachments (N)
                    â”‚
                    â”œâ”€â”€ origem_anexo_id â”€â”€â”€> pagamentos (N)
                                               â”‚
                                               â””â”€â”€ pessoa_id â”€â”€â”€> pessoas_fisicas (1)
```

ðŸ‘‰ **Fluxo natural dos dados:**

1. ðŸ“© O e-mail chega â†’ Ã© salvo em `emails`
2. ðŸ“Ž Seus anexos vÃ£o para `email_attachments`
3. ðŸ’° Se o anexo for um comprovante â†’ cria/atualiza `pagamentos`
4. ðŸ‘¤ O pagamento atualiza `pessoas_fisicas` (valor, data, tipo de assinatura)
5. ðŸŽ¯ Esses dados alimentam seus painÃ©is e automaÃ§Ãµes (convites, campanhas, relatÃ³rios)

---

## ðŸ§® CONSULTAS E ATUALIZAÃ‡Ã•ES FEITAS

### ðŸ”§ Estrutura e consistÃªncia

* Criamos as tabelas base com **UUIDs, Ã­ndices e FKs**.
* Garantimos **Row Level Security** para uso seguro com Supabase e n8n.
* Criamos extensÃµes `pgcrypto` e `pg_trgm`.

### ðŸ“Š AtualizaÃ§Ãµes e sincronizaÃ§Ãµes

* Vinculamos `pagamentos.pessoa_id` com `pessoas_fisicas.id` via e-mail.
* Atualizamos automaticamente:

  * `valor_ultimo_pagamento`
  * `data_ultimo_pagamento`
  * `tipo_assinatura` (mensal/anual)
* Garantimos consistÃªncia mesmo se o dado vier sÃ³ com e-mail.

### ðŸ” Consultas criadas

* Listagem de estrutura do banco (`information_schema.columns`)
* RelatÃ³rios de assinaturas mensais/anuais
* Listagem de pessoas com seus Ãºltimos pagamentos
* Checagem de vÃ­nculos e FKs

---

## ðŸ§  LÃ“GICA DE CLASSIFICAÃ‡ÃƒO FINANCEIRA

| CondiÃ§Ã£o       | Tipo de assinatura |
| -------------- | ------------------ |
| `valor >= 100` | `anual`            |
| `valor < 100`  | `mensal`           |

Essa lÃ³gica foi aplicada tanto na `pagamentos` quanto replicada em `pessoas_fisicas`.

---

## ðŸ“ˆ PRÃ“XIMO PASSO (recomendado)

1. **Criar uma VIEW consolidada**, ex:

   ```sql
   create view public.vw_pessoas_pagamentos as
   select
     pf.id,
     pf.nome,
     pf.email,
     pf.tipo_assinatura,
     pf.data_ultimo_pagamento,
     pf.valor_ultimo_pagamento
   from public.pessoas_fisicas pf;
   ```

2. **Usar essa view** no painel de controle do Supabase ou no n8n para exibir os afiliados com pagamentos atualizados.

3. **Adicionar triggers automÃ¡ticas (opcional)** para atualizar `pessoas_fisicas` sempre que houver novo `pagamento`.

---

## ðŸ§© RESUMO VISUAL

| Origem              | Destino             | Tipo         | PropÃ³sito                          |
| ------------------- | ------------------- | ------------ | ---------------------------------- |
| `emails`            | `email_attachments` | 1:N          | Armazena anexos                    |
| `email_attachments` | `pagamentos`        | 1:1 opcional | LigaÃ§Ã£o de comprovantes            |
| `pagamentos`        | `pessoas_fisicas`   | N:1          | Atualiza Ãºltimos pagamentos e tipo |
| `pessoas_fisicas`   | (painÃ©is e fluxos)  | â€”            | Base de contatos central           |

---


