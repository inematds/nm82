Excelente, Nei ğŸ‘ â€” essa Ã© a etapa natural de evoluÃ§Ã£o do seu ecossistema: transformar todas as bases e automaÃ§Ãµes que vocÃª jÃ¡ construiu (**e-mails, anexos, pagamentos, pessoas, convites e afiliados**) em um **sistema completo de acompanhamento inteligente e preditivo**, com consultas, verificaÃ§Ãµes, alertas e relatÃ³rios.

Abaixo estÃ¡ o **plano tÃ©cnico detalhado e modular**, pronto para implementaÃ§Ã£o no **Supabase + n8n + painel web (ou Supabase Dashboard)**.

---

# ğŸ§  SISTEMA COMPLETO DE CONSULTA, VERIFICAÃ‡ÃƒO E ACOMPANHAMENTO

### *(Arquitetura INEMA FTD 360)*

---

## âš™ï¸ MÃ“DULO 1 â€” Consulta e VerificaÃ§Ã£o de Dados

### ğŸ¯ Objetivo:

Garantir que todas as tabelas estejam consistentes, atualizadas e sem falhas.

### ğŸ” FunÃ§Ãµes principais:

| FunÃ§Ã£o                          | DescriÃ§Ã£o                                                   |
| ------------------------------- | ----------------------------------------------------------- |
| **Verificar estrutura**         | Confere se tabelas e colunas existem (`information_schema`) |
| **Verificar FKs**               | Confirma relaÃ§Ãµes (`pessoa_id`, `origem_anexo_id`)          |
| **Checar vÃ­nculos pendentes**   | Lista pagamentos sem `pessoa_id` e e-mails sem anexo        |
| **DetecÃ§Ã£o de inconsistÃªncias** | Ex: duplicados, nulos ou registros Ã³rfÃ£os                   |

### ğŸ§© SQL base:

```sql
-- Verifica pagamentos sem vÃ­nculo com pessoa
select id, email, valor, data_pagamento
from public.pagamentos
where pessoa_id is null;

-- Verifica anexos sem e-mail
select id, filename
from public.email_attachments
where message_id not in (select message_id from public.emails);
```

ğŸ” **Agendamento no n8n:**
Roda a cada 12h e grava um log no Supabase (`verificacoes_log`).

---

## ğŸ“¬ MÃ“DULO 2 â€” Monitoramento de Novos E-mails

### ğŸ¯ Objetivo:

Detectar novos e-mails recebidos (via Gmail API â†’ n8n), identificar se sÃ£o **convites** ou **comprovantes**.

### ğŸ” FunÃ§Ãµes principais:

| AÃ§Ã£o                         | DescriÃ§Ã£o                                 |
| ---------------------------- | ----------------------------------------- |
| **Buscar novos e-mails**     | n8n lÃª Ãºltimos 100 e-mails via Gmail node |
| **Filtrar por assunto**      | â€œConvite INEMAâ€, â€œComprovanteâ€, etc.      |
| **Salvar no Supabase**       | insere em `emails` e `email_attachments`  |
| **Extrair remetente e nome** | atualiza ou cria em `pessoas_fisicas`     |

### âš™ï¸ AutomaÃ§Ã£o:

```bash
Gmail â†’ Supabase (emails + attachments)
      â†’ Verifica se Ã© comprovante
      â†’ Atualiza pagamentos
      â†’ Atualiza pessoas_fisicas
```

ğŸ”” **NotificaÃ§Ã£o automÃ¡tica:**
Se o assunto for â€œcomprovanteâ€, envia mensagem de confirmaÃ§Ã£o (â€œSeu comprovante foi recebido e estÃ¡ em anÃ¡liseâ€).

---

## ğŸ’° MÃ“DULO 3 â€” AtualizaÃ§Ã£o AutomÃ¡tica de Pagamentos

### ğŸ¯ Objetivo:

Manter `pessoas_fisicas` sempre com as informaÃ§Ãµes de pagamento mais recentes.

### ğŸ”§ FunÃ§Ã£o:

Atualizar:

* `data_ultimo_pagamento`
* `valor_ultimo_pagamento`
* `tipo_assinatura`

```sql
update public.pessoas_fisicas pf
set
  valor_ultimo_pagamento = p.valor,
  data_ultimo_pagamento  = p.data_pagamento,
  tipo_assinatura = case when p.valor >= 100 then 'anual' else 'mensal' end
from (
  select distinct on (pessoa_id)
    pessoa_id, valor, data_pagamento
  from public.pagamentos
  order by pessoa_id, data_pagamento desc
) p
where pf.id = p.pessoa_id;
```

ğŸ” **Agendamento:** rodar 1x por dia no n8n.

---

## â° MÃ“DULO 4 â€” Alerta de Vencimentos

### ğŸ¯ Objetivo:

Avisar afiliados e padrinhos sobre vencimentos prÃ³ximos.

### âš™ï¸ LÃ³gica:

```sql
select
  nome, email, data_vencimento,
  tipo_assinatura,
  (data_vencimento - current_date) as dias_restantes
from public.pessoas_fisicas
where data_vencimento is not null
  and (data_vencimento - current_date) <= 5;
```

ğŸ’¬ **n8n Workflow:**

* Busca registros com vencimento â‰¤ 5 dias
* Envia e-mail ou mensagem Telegram:
  â€œOlÃ¡ {{nome}}, sua assinatura vence em {{dias_restantes}} dias.â€

---

## ğŸ“ˆ MÃ“DULO 5 â€” RelatÃ³rios e PainÃ©is

### ğŸ¯ Objetivo:

Gerar dashboards de desempenho e receita.

### ğŸ” Principais relatÃ³rios:

| Tipo           | MÃ©trica                                         |
| -------------- | ----------------------------------------------- |
| ğŸ“Š Financeiro  | Total de receita, assinaturas mensais vs anuais |
| ğŸ‘¥ AfiliaÃ§Ã£o   | Novos afiliados, padrinhos ativos               |
| ğŸ“¬ ComunicaÃ§Ã£o | E-mails recebidos, comprovantes processados     |
| ğŸ• RetenÃ§Ã£o    | MÃ©dia de tempo entre pagamentos                 |

### âš™ï¸ SQL de exemplo:

```sql
select
  tipo_assinatura,
  count(*) as total_clientes,
  sum(valor_ultimo_pagamento) as receita_total
from public.pessoas_fisicas
group by tipo_assinatura;
```

ğŸ“Š **GrÃ¡ficos sugeridos (painel 3):**

* Linha: novos afiliados por dia
* Barra: pagamentos por semana
* Pizza: % mensal x anual

---

## ğŸ¤– MÃ“DULO 6 â€” Mensagens e PrevisÃ£o Inteligente

### ğŸ¯ Objetivo:

Usar IA para prever comportamento e automatizar comunicaÃ§Ãµes.

| FunÃ§Ã£o                      | DescriÃ§Ã£o                                    |
| --------------------------- | -------------------------------------------- |
| **PrevisÃ£o de vencimentos** | IA estima quem pode nÃ£o renovar              |
| **Mensagem proativa**       | â€œPercebemos que seu plano vence em breve...â€ |
| **AnÃ¡lise de adesÃ£o**       | Mede taxa de novos convites e conversÃ£o      |

ğŸ” **Dados de entrada:**

* histÃ³rico de pagamentos
* data_ultimo_pagamento
* valor
* convites_usados

ğŸ’¡ Pode ser feito via **n8n + LLM (OpenAI)** â†’ analisando a tabela `pessoas_fisicas`.

---

## ğŸ”” MÃ“DULO 7 â€” Alertas e NotificaÃ§Ãµes

| Tipo de alerta     | DestinatÃ¡rio | AÃ§Ã£o                   |
| ------------------ | ------------ | ---------------------- |
| Pagamento atrasado | Afiliado     | Enviar lembrete        |
| Novo comprovante   | Admin        | Revisar                |
| Convites esgotando | Padrinho     | Liberar novos convites |
| CÃ³digo expirando   | Admin        | Renovar plano          |

ğŸ“¨ Entrega: via e-mail, Telegram Bot ou mensagem no painel.

---

## ğŸ§© MÃ“DULO 8 â€” Painel de Controle Geral

**Fontes:** `pessoas_fisicas`, `pagamentos`, `emails`, `afiliados`, `codigos_convite`

### Telas:

1. **Resumo geral**

   * Total de afiliados, receita total, convites disponÃ­veis
2. **TendÃªncias**

   * GrÃ¡ficos de novos afiliados, pagamentos, convites
3. **Alertas**

   * Vencimentos prÃ³ximos, afiliados inativos
4. **Mensagens**

   * E-mails recentes, comprovantes pendentes
5. **PrevisÃµes**

   * RenovaÃ§Ã£o esperada, taxa de retenÃ§Ã£o

---

## ğŸ”— MÃ“DULO 9 â€” IntegraÃ§Ã£o com IA e AutomaÃ§Ã£o

* **n8n:** coleta e sincroniza dados (Gmail â†’ Supabase â†’ notificaÃ§Ãµes)
* **Supabase:** armazena e expÃµe via API REST
* **ChatGPT / Agent INEMA:** analisa e explica relatÃ³rios em linguagem natural
* **Telegram Bot:** permite padrinhos consultarem convites e afiliados

---

## ğŸ§­ EM RESUMO

| Fluxo      | Origem     | Destino      | FunÃ§Ã£o                         |
| ---------- | ---------- | ------------ | ------------------------------ |
| E-mails    | Gmail      | Supabase     | Captura e classifica mensagens |
| Anexos     | Gmail      | Storage      | Armazena comprovantes          |
| Pagamentos | Anexos     | Supabase     | Atualiza financeiro            |
| Pessoas    | Pagamentos | Supabase     | Consolida status e planos      |
| Convites   | UsuÃ¡rio    | Supabase     | Expande comunidade             |
| Alertas    | Supabase   | n8n/Telegram | Avisa sobre vencimentos        |
| RelatÃ³rios | Supabase   | Painel / IA  | Gera insights e previsÃµes      |

---



1. ğŸ§± **O script SQL completo** (com views, triggers e tabelas auxiliares), **ou**
2. ğŸ§­ **Um diagrama visual 16:9** com todos os mÃ³dulos e fluxos (ideal pra painel ou apresentaÃ§Ã£o), **ou**
3. ğŸ’» **Um arquivo `.n8n` pronto com esses workflows integrados.**

