Perfeito, Nei ğŸ‘Œ â€” agora estamos conectando a Ãºltima peÃ§a essencial do seu ecossistema:
o **fluxo de convites e afiliaÃ§Ãµes** â€” que completa o ciclo entre **pessoas_fisicas â†’ afiliados â†’ cÃ³digos de convite**, integrando tudo ao modelo de e-mails e pagamentos que jÃ¡ estruturamos.

A seguir estÃ¡ um **resumo tÃ©cnico do fluxo dos convites**, incluindo as tabelas envolvidas, os relacionamentos, e como isso se integra ao resto do sistema.

---

# ğŸ§­ VISÃƒO GERAL DO FLUXO DE CONVITES

O objetivo do fluxo Ã© permitir que **qualquer membro da comunidade (pessoa_fisica)**
possa **convidar novos afiliados** atravÃ©s de **cÃ³digos Ãºnicos**, controlando:

* convites disponÃ­veis
* convites usados
* padrinho (quem convidou)
* afiliado (quem recebeu e aceitou o convite)

---

## ğŸ§± 1. Estrutura das tabelas do fluxo

### **ğŸ§ pessoas_fisicas**

> JÃ¡ existente â€” Ã© a **base de todos os participantes**, tanto padrinhos quanto afiliados.

Campos relevantes:

| Campo               | FunÃ§Ã£o                                   |
| ------------------- | ---------------------------------------- |
| `id`                | Identificador Ãºnico                      |
| `email`             | Chave natural para vÃ­nculos              |
| `convites_enviados` | Quantos convites jÃ¡ enviou               |
| `convites_usados`   | Quantos foram aceitos                    |
| `convites_dtatual`  | Controle de data da contagem de convites |
| `ativo`             | Status do membro                         |

---

### **ğŸ”‘ codigos_convite**

> ContÃ©m os cÃ³digos Ãºnicos e seus parÃ¢metros.

| Campo            | Tipo        | DescriÃ§Ã£o                                                  |
| ---------------- | ----------- | ---------------------------------------------------------- |
| `codigo`         | text (PK)   | CÃ³digo de convite (ex: `756a57e2eaba4632688ad282210dbabc`) |
| `accessLink`     | text        | Link pÃºblico do convite                                    |
| `plano`          | text        | Ex: â€œMensal 2025â€, â€œAnual 2025â€                            |
| `maxActivations` | int         | NÃºmero mÃ¡ximo de usos                                      |
| `expiration`     | timestamptz | Data de validade                                           |
| `usos_atuais`    | int         | Quantas vezes jÃ¡ foi usado                                 |
| `padrinho_id`    | uuid        | FK â†’ pessoas_fisicas.id (quem gerou o cÃ³digo)              |
| `ativo`          | boolean     | Indica se o cÃ³digo ainda pode ser usado                    |

---

### **ğŸ¤ afiliados**

> Registra quem **aceitou o convite** e se associou Ã  comunidade.

| Campo            | Tipo        | DescriÃ§Ã£o                             |
| ---------------- | ----------- | ------------------------------------- |
| `id`             | uuid (PK)   | Identificador do afiliado             |
| `padrinho_id`    | uuid        | FK â†’ pessoas_fisicas.id               |
| `codigo_convite` | text        | FK â†’ codigos_convite.codigo           |
| `afiliado_id`    | uuid        | FK â†’ pessoas_fisicas.id (quem entrou) |
| `data_convite`   | timestamptz | Quando o convite foi enviado          |
| `data_aceite`    | timestamptz | Quando o afiliado aceitou             |
| `status`         | text        | ex: â€œpendenteâ€, â€œaceitoâ€, â€œexpiradoâ€  |

---

## ğŸ”— 2. RELACIONAMENTO ENTRE AS TABELAS

```
pessoas_fisicas (1)
   â”œâ”€â”€< codigos_convite (N)
   â”‚        â””â”€â”€< afiliados (N)
   â”‚                â”œâ”€â”€ padrinho_id â†’ pessoas_fisicas.id
   â”‚                â””â”€â”€ afiliado_id â†’ pessoas_fisicas.id
```

ğŸ‘‰ Em palavras:

* Cada **pessoa fÃ­sica** pode gerar vÃ¡rios **cÃ³digos**.
* Cada **cÃ³digo** pode ser usado por vÃ¡rios **afiliados** (atÃ© o limite).
* Cada **afiliado** Ã© tambÃ©m um registro em `pessoas_fisicas`.

---

## âš™ï¸ 3. FLUXO OPERACIONAL DO CONVITE

### ğŸ“¨ Etapa 1 â€” GeraÃ§Ã£o do cÃ³digo

* O padrinho gera um **cÃ³digo Ãºnico** (registrado em `codigos_convite`).
* O cÃ³digo inclui: tipo de plano, validade e nÃºmero mÃ¡ximo de ativaÃ§Ãµes.

```sql
insert into public.codigos_convite (codigo, accessLink, plano, maxActivations, expiration, padrinho_id)
values ('756a57e2eaba4632688ad282210dbabc',
        'https://t.me/INEMAMembroBot?start=c756a57e2eaba4632688ad282210dbabc',
        'Mensal 2025',
        1,
        '2025-11-30T00:00:00+00:00',
        'UUID_do_padrinho');
```

---

### ğŸ’Œ Etapa 2 â€” Envio do convite

* O sistema envia o link do convite (por e-mail, Telegram ou n8n).
* O padrinho Ã© avisado: â€œConvite enviado â€” 4 restantes.â€

---

### ğŸ§¾ Etapa 3 â€” Aceite do afiliado

* Quando o convidado entra pelo link, o fluxo cadastra:

  * o afiliado em `pessoas_fisicas` (se nÃ£o existir),
  * um registro em `afiliados` com vÃ­nculo ao padrinho,
  * e incrementa os contadores.

```sql
update pessoas_fisicas
set convites_usados = convites_usados + 1
where id = (select padrinho_id from codigos_convite where codigo = '...');

update codigos_convite
set usos_atuais = usos_atuais + 1
where codigo = '...';
```

---

### ğŸ§  Etapa 4 â€” IntegraÃ§Ã£o com pagamentos

Se o afiliado fizer pagamento:

* o sistema atualiza `pessoas_fisicas.valor_ultimo_pagamento` e `data_ultimo_pagamento`,
* o padrinho pode ganhar convites extras ou bÃ´nus.

---

## ğŸ“ˆ 4. EXEMPLOS DE CONSULTAS ÃšTEIS

### ğŸ” Quantos convites cada padrinho jÃ¡ usou:

```sql
select
  pf.nome,
  pf.email,
  pf.convites_enviados,
  pf.convites_usados,
  (pf.convites_enviados - pf.convites_usados) as convites_disponiveis
from public.pessoas_fisicas pf
order by convites_disponiveis desc;
```

---

### ğŸ”‘ Quantos cÃ³digos ainda ativos:

```sql
select
  codigo,
  plano,
  maxActivations,
  usos_atuais,
  (maxActivations - usos_atuais) as restantes,
  expiration
from public.codigos_convite
where ativo = true;
```

---

### ğŸ¤ Afiliados aceitos recentemente:

```sql
select
  a.data_aceite,
  padrinho.nome as nome_padrinho,
  afiliado.nome as nome_afiliado,
  c.plano,
  c.codigo
from public.afiliados a
join public.pessoas_fisicas padrinho on a.padrinho_id = padrinho.id
join public.pessoas_fisicas afiliado on a.afiliado_id = afiliado.id
join public.codigos_convite c on a.codigo_convite = c.codigo
order by a.data_aceite desc;
```

---

## ğŸ§© 5. INTEGRAÃ‡ÃƒO COM O ECOSSISTEMA

| MÃ³dulo                          | Relacionamento                         | Finalidade                           |
| ------------------------------- | -------------------------------------- | ------------------------------------ |
| `emails`                        | Origem dos convites (envio automÃ¡tico) | Gatilho de convites                  |
| `email_attachments`             | Comprovantes de pagamento              | ValidaÃ§Ã£o de afiliado                |
| `pagamentos`                    | Define status ativo/anual/mensal       | Atualiza pessoas                     |
| `pessoas_fisicas`               | NÃºcleo do sistema                      | Une tudo                             |
| `codigos_convite` + `afiliados` | Rede de convites                       | Crescimento e rastreio da comunidade |

---

## ğŸ§­ RESUMO VISUAL

```
pessoas_fisicas
 â”œâ”€â”€< codigos_convite
 â”‚       â”œâ”€â”€ codigo
 â”‚       â”œâ”€â”€ plano
 â”‚       â”œâ”€â”€ expiration
 â”‚       â”œâ”€â”€ padrinho_id â†’ pessoas_fisicas.id
 â”‚       â””â”€â”€ usos_atuais / maxActivations
 â””â”€â”€< afiliados
         â”œâ”€â”€ afiliado_id â†’ pessoas_fisicas.id
         â”œâ”€â”€ padrinho_id â†’ pessoas_fisicas.id
         â”œâ”€â”€ codigo_convite â†’ codigos_convite.codigo
         â””â”€â”€ data_aceite / status
```

---

Posso gerar agora um **diagrama visual 16:9** desse fluxo (com as tabelas `pessoas_fisicas`, `codigos_convite` e `afiliados` + relacionamentos)
no mesmo estilo dos anteriores â€” ideal pra documentar ou mostrar em palestra.
Quer que eu gere a imagem?

